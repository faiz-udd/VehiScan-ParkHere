{% extends 'master.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Find Parking Near {{ location }} - VehiScan{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  /* Modern UI styling */
  body { font-family: 'Roboto', Arial, sans-serif; background: #f5f6fa; }
  h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', Arial, sans-serif; }
  
  /* Map container enhancements */
  .map-container {
    position: relative;
    height: calc(100vh - 70px);
  }
  
  #map {
    height: 100%;
    width: 100%;
    border-radius: 0;
    z-index: 1;
  }
  
  /* Search overlay on map */
  .map-search-overlay {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    padding: 16px;
  }
  
  /* Listings panel */
  .listings-panel {
    height: calc(100vh - 70px);
    overflow-y: auto;
    background: #f8f9fa;
    padding: 20px;
    scrollbar-width: thin;
  }
  
  .listings-panel::-webkit-scrollbar {
    width: 6px;
  }
  
  .listings-panel::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  
  .listings-panel::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }
  
  .parking-lot-card {
    border-radius: 16px;
    overflow: hidden;
    border: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 16px;
  }
  
  .parking-lot-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  
  .parking-lot-card .card-img {
    height: 160px;
    object-fit: cover;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
  }
  
  .card-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    z-index: 2;
  }
  
  .availability-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
  }
  
  .availability-high {
    background-color: #2dc98a;
  }
  
  .availability-medium {
    background-color: #f39c12;
  }
  
  .availability-low {
    background-color: #e74c3c;
  }
  
  .lot-distance {
    font-size: 0.8rem;
    color: #6c757d;
    display: flex;
    align-items: center;
  }
  
  .lot-features {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  
  .lot-feature {
    background-color: #f8f9fa;
    border-radius: 30px;
    padding: 4px 12px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #495057;
    display: flex;
    align-items: center;
  }
  
  .lot-feature i {
    margin-right: 5px;
    font-size: 0.7rem;
  }
  
  .price-badge {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 2;
    background: linear-gradient(90deg, #2dc98a 0%, #44b8f3 100%);
    color: white;
    font-weight: 600;
    border-radius: 30px;
    padding: 5px 12px;
    font-size: 0.9rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .availability-badge {
    border-radius: 30px;
    padding: 5px 12px;
    font-weight: 500;
  }
  
  .filter-bar {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .filter-btn {
    border-radius: 20px;
    font-size: 0.8rem;
    padding: 6px 15px;
    margin-right: 8px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    color: #495057;
  }
  
  .filter-btn.active {
    background: #2dc98a;
    color: white;
    border-color: #2dc98a;
  }
  
  .filter-btn:hover {
    background: #e9ecef;
  }
  
  .filter-btn.active:hover {
    background: #28b67d;
  }
  
  /* Custom marker */
  .custom-marker {
    text-align: center;
    color: white;
    font-weight: 700;
    font-size: 14px;
    padding-top: 6px;
  }
  
  .custom-marker-container {
    background: linear-gradient(90deg, #2dc98a 0%, #44b8f3 100%);
    width: 36px;
    height: 36px;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  .custom-marker-content {
    transform: rotate(45deg);
  }
  
  /* Responsive adjustments */
  @media (max-width: 992px) {
    .map-container {
      height: 40vh;
      margin-bottom: 20px;
    }
    
    .listings-panel {
      height: auto;
      max-height: unset;
    }
    
    .map-search-overlay {
      position: static;
      margin-bottom: 20px;
      border-radius: 12px;
    }
  }
  
  .no-results {
    padding: 40px 20px;
    text-align: center;
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .no-results i {
    font-size: 3rem;
    color: #6c757d;
    margin-bottom: 20px;
  }
</style>
{% endblock %}

{% block main %}
<div class="container-fluid p-0">
  <div class="row g-0">
    <!-- Map Column -->
    <div class="col-lg-7">
      <div class="map-container">
        <div id="map"></div>
        
        <!-- Search overlay -->
        <div class="map-search-overlay">
          <div class="row align-items-center">
            <div class="col-lg-5">
              <h5 class="mb-0"><i class="fas fa-map-marker-alt text-primary me-2"></i> Parking near {{ location }}</h5>
              <p class="text-muted mb-lg-0 mt-1 small">{{ parking_lots|length }} parking spaces available</p>
            </div>
            <div class="col-lg-7">
              <div class="d-flex">
                <form class="input-group" method="get" action="">
                  <input type="hidden" name="location" value="{{ location }}">
                  <input type="text" class="form-control" placeholder="Search by name or address..." id="searchInput" name="search" value="{{ request.GET.search }}">
                  <button class="btn btn-primary" type="submit">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Listings Column -->
    <div class="col-lg-5">
      <div class="listings-panel">
        <!-- Filter bar -->
        <div class="filter-bar mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-bold">Filters</h6>
            <a href="?location={{ location }}" class="text-decoration-none small">Clear all</a>
          </div>
          <div class="d-flex flex-wrap">
            <button class="filter-btn me-2 mb-2 {% if request.GET.filter == 'nearest' or not request.GET.filter %}active{% endif %}" data-filter="nearest">
              <i class="fas fa-location-arrow me-1"></i> Nearest
            </button>
            <button class="filter-btn me-2 mb-2 {% if request.GET.filter == 'available' %}active{% endif %}" data-filter="available">
              <i class="fas fa-check-circle me-1"></i> Available
            </button>
            <button class="filter-btn me-2 mb-2 {% if request.GET.filter == 'cheapest' %}active{% endif %}" data-filter="cheapest">
              <i class="fas fa-tags me-1"></i> Cheapest
            </button>
            <button class="filter-btn me-2 mb-2 {% if request.GET.filter == 'paid' %}active{% endif %}" data-filter="paid">
              <i class="fas fa-money-bill me-1"></i> Paid
            </button>
            <button class="filter-btn mb-2 {% if request.GET.filter == 'free' %}active{% endif %}" data-filter="free">
              <i class="fas fa-hand-holding me-1"></i> Free
            </button>
          </div>
        </div>
        
        <!-- Parking Listings -->
        <div id="parkingListings">
          {% for lot in parking_lots %}
          {% if lot.status == 'live' %}
          <div class="parking-lot-card card shadow-sm mb-4" data-lot-id="{{ lot.id }}" 
               data-lat="{{ lot.latitude }}" data-lng="{{ lot.longitude }}">
            <div class="position-relative">
              <img src="{{ lot.get_image_url }}" class="card-img" alt="{{ lot.name }}">
              <div class="price-badge">
                <i class="fas fa-tag me-1"></i> PKR {{ lot.base_price_per_hour }}/hr
              </div>
              {% if lot.get_probability_parking_available > 75 %}
              <span class="badge bg-success card-badge availability-badge">
                <i class="fas fa-circle me-1"></i> High Availability
              </span>
              {% elif lot.get_probability_parking_available > 30 %}
              <span class="badge bg-warning card-badge availability-badge">
                <i class="fas fa-circle me-1"></i> Medium Availability
              </span>
              {% else %}
              <span class="badge bg-danger card-badge availability-badge">
                <i class="fas fa-circle me-1"></i> Low Availability
              </span>
              {% endif %}
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0 fw-bold">{{ lot.name }}</h5>
                <span class="lot-distance">
                  <i class="fas fa-location-arrow me-1"></i> {{ lot.distance|floatformat:1 }}km
                </span>
              </div>
              <p class="card-text text-muted mb-2">
                <i class="fas fa-map-marker-alt me-1 text-primary"></i> {{ lot.address|truncatechars:45 }}
              </p>
              <div class="lot-features">
                {% if lot.isPaidParking %}
                <span class="lot-feature">
                  <i class="fas fa-money-bill"></i> Paid
                </span>
                {% else %}
                <span class="lot-feature">
                  <i class="fas fa-hand-holding"></i> Free
                </span>
                {% endif %}
                <span class="lot-feature">
                  <i class="fas fa-car"></i> {{ lot.get_free_parking_spaces }}/{{ lot.parking_spaces }} Spaces
                </span>
                <span class="lot-feature">
                  <i class="fas fa-clock"></i> {{ lot.hours|truncatechars:15 }}
                </span>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="d-flex align-items-center">
                  {% if lot.get_free_parking_spaces > 0 %}
                  <span class="availability-indicator availability-high"></span>
                  <span class="small fw-medium">{{ lot.get_free_parking_spaces }} spaces available</span>
                  {% else %}
                  <span class="availability-indicator availability-low"></span>
                  <span class="small fw-medium text-danger">Full</span>
                  {% endif %}
                </div>
                <a href="{% url 'parking-lot-detail' lot.id %}" class="btn btn-primary btn-sm">
                  View Details
                </a>
              </div>
            </div>
          </div>
          {% endif %}
          {% empty %}
          <div class="no-results">
            <i class="fas fa-search"></i>
            <h4>No Parking Spaces Found</h4>
            <p class="text-muted">We couldn't find any parking spaces in this area. Try expanding your search or try a different location.</p>
            <a href="{% url 'home' %}" class="btn btn-primary mt-3">
              <i class="fas fa-home me-2"></i> Back to Home
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Map initialization
  const map = L.map('map', {
    zoomControl: false  // We'll add it in a better position
  }).setView({{ search_coords }}, 13);
  
  // Add zoom control to bottom right
  L.control.zoom({
    position: 'bottomright'
  }).addTo(map);

  // Add OpenStreetMap tiles with enhanced styling
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | VehiScan',
    maxZoom: 19
  }).addTo(map);

  // Add search area circle with improved styling
  L.circle({{ search_coords }}, {
    color: '#2dc98a',
    fillColor: '#2dc98a',
    fillOpacity: 0.1,
    weight: 2,
    radius: 3000 // 3km radius
  }).addTo(map);
  
  // Add user location marker
  const userIcon = L.divIcon({
    className: 'user-location-marker',
    html: `<div style="background-color:#3498db; width:16px; height:16px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>`,
    iconSize: [16, 16],
    iconAnchor: [8, 8]
  });
  
  L.marker({{ search_coords }}, {icon: userIcon})
    .bindTooltip("Your Location", {permanent: false, direction: 'top'})
    .addTo(map);

  // Custom marker for parking lots
  function createCustomMarker(lot) {
    const availability = lot.free_spaces > 0 ? 'available' : 'full';
    const colorClass = availability === 'available' ? '#2dc98a' : '#e74c3c';
    
    return L.divIcon({
      className: 'custom-marker',
      html: `
        <div class="custom-marker-container" style="background:${colorClass}">
          <div class="custom-marker-content">${lot.price}pkr</div>
        </div>
      `,
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -36]
    });
  }

  // Create marker for each parking lot
  const markers = {};
  {% for lot in parking_lots %}
  {% if lot.status == 'live' %}
  (function() {
    const lot = {
      id: {{ lot.id }},
      name: "{{ lot.name|escapejs }}",
      address: "{{ lot.address|escapejs }}",
      lat: {{ lot.latitude }},
      lng: {{ lot.longitude }},
      free_spaces: {{ lot.get_free_parking_spaces }},
      total_spaces: {{ lot.parking_spaces }},
      price: {{ lot.base_price_per_hour }}
    };
    
    const customIcon = createCustomMarker(lot);
    
    const marker = L.marker([lot.lat, lot.lng], {
      icon: customIcon,
      riseOnHover: true
    }).addTo(map);
    
    // Create popup with more details
    const popupContent = `
      <div style="width: 220px;">
        <h5 style="font-weight:600; margin-bottom:8px;">${lot.name}</h5>
        <p style="color:#666; font-size:13px; margin-bottom:8px;">
          <i class="fas fa-map-marker-alt" style="color:#2dc98a"></i> ${lot.address}
        </p>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <span style="background:${lot.free_spaces > 0 ? '#e3fcef' : '#fee7e7'}; color:${lot.free_spaces > 0 ? '#2dc98a' : '#e74c3c'}; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:500;">
              ${lot.free_spaces}/${lot.total_spaces} Spaces
            </span>
          </div>
          <a href="/parking-lots/${lot.id}/" style="background:#2dc98a; color:white; text-decoration:none; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:500;">
            Details
          </a>
        </div>
      </div>
    `;
    
    marker.bindPopup(popupContent);
    markers[lot.id] = marker;
    
    // Highlight card when hovering over marker
    marker.on('mouseover', function() {
      document.querySelector(`.parking-lot-card[data-lot-id="${lot.id}"]`)?.classList.add('border-primary');
    });
    
    marker.on('mouseout', function() {
      document.querySelector(`.parking-lot-card[data-lot-id="${lot.id}"]`)?.classList.remove('border-primary');
    });
  })();
  {% endif %}
  {% endfor %}
  
  // Handle card hover to highlight markers
  document.querySelectorAll('.parking-lot-card').forEach(card => {
    card.addEventListener('mouseover', function() {
      const lotId = this.getAttribute('data-lot-id');
      if (markers[lotId]) {
        markers[lotId].openPopup();
        this.classList.add('border-primary');
      }
    });
    
    card.addEventListener('mouseout', function() {
      const lotId = this.getAttribute('data-lot-id');
      if (markers[lotId]) {
        markers[lotId].closePopup();
        this.classList.remove('border-primary');
      }
    });
    
    // Card click centers map on the parking lot location
    card.addEventListener('click', function(e) {
      if (e.target.tagName !== 'A') {
        const lat = parseFloat(this.getAttribute('data-lat'));
        const lng = parseFloat(this.getAttribute('data-lng'));
        map.setView([lat, lng], 16);
        
        // On mobile, scroll to map
        if (window.innerWidth < 992) {
          document.getElementById('map').scrollIntoView({behavior: 'smooth'});
        }
      }
    });
  });

  // Search functionality with debounce
  let searchTimeout;
  document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('.parking-lot-card').forEach(card => {
        const title = card.querySelector('.card-title').textContent.toLowerCase();
        const address = card.querySelector('.card-text').textContent.toLowerCase();
        
        if (title.includes(searchTerm) || address.includes(searchTerm)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }, 300);
  });
  
  // Filter buttons functionality
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const filter = this.getAttribute('data-filter');
      window.location.href = `?location={{ location }}&filter=${filter}`;
    });
  });
  
  // Make sure the map is resized when the window is resized
  window.addEventListener('resize', function() {
    map.invalidateSize();
  });
});
</script>
{% endblock %}