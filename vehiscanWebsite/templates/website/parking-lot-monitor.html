{% extends 'master.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ parking_lot_monitor.name }} - VehiScan{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  /* Hero section with gradient overlay */
  .monitor-hero {
    position: relative;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    padding: 6rem 0 4rem;
    border-radius: 0;
    overflow: hidden;
    background-color: #44b8f3;
  }
  
  .monitor-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to right, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 100%);
    z-index: 1;
  }
  
  .breadcrumb {
    background-color: transparent;
  }
  
  .breadcrumb-item a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: color 0.2s ease;
  }
  
  .breadcrumb-item a:hover {
    color: white;
  }
  
  .breadcrumb-item.active {
    color: white;
  }
  
  .breadcrumb-item+.breadcrumb-item::before {
    color: rgba(255,255,255,0.5);
  }
  
  .last-updated-badge {
    background-color: rgba(255,255,255,0.15);
    backdrop-filter: blur(5px);
    border-radius: 50px;
    padding: 0.5rem 1rem;
    display: inline-flex;
    align-items: center;
    font-size: 0.9rem;
  }
  
  .monitor-availability {
    background: white;
    border-radius: 16px;
    margin-top: -3rem;
    position: relative;
    z-index: 10;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .availability-indicator {
    width: 100%;
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
    position: relative;
  }
  
  .availability-bar {
    height: 100%;
    border-radius: 5px;
    transition: width 1.5s ease-in-out;
  }
  
  .stat-card {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    height: auto;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 24px;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .map-container {
    height: 450px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }
  
  #monitorMap {
    height: 100%;
    width: 100%;
  }
  
  .section-heading {
    position: relative;
    padding-bottom: 1rem;
    margin-bottom: 2rem;
    font-weight: 700;
  }
  
  .section-heading::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(to right, #2dc98a, #44b8f3);
    border-radius: 2px;
  }
  
  .detail-stat {
    text-align: center;
    padding: 2rem 1rem;
    background: #f8f9fa;
    border-radius: 16px;
    transition: transform 0.3s ease;
    height: auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 220px;
  }
  
  .detail-stat:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.05);
  }
  
  .stat-value {
    font-size: 3rem;
    font-weight: 700;
    display: block;
    color: #2dc98a;
    margin-bottom: 0.5rem;
  }
  
  .stat-icon {
    font-size: 2rem;
    color: #44b8f3;
    margin-bottom: 1rem;
  }
  
  .stat-label {
    font-size: 1rem;
    color: #495057;
    font-weight: 500;
  }
  
  .directions-btn {
    background: linear-gradient(135deg, #2dc98a 0%, #44b8f3 100%);
    border: none;
    border-radius: 50px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    color: white;
    box-shadow: 0 5px 15px rgba(45, 201, 138, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .directions-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(45, 201, 138, 0.4);
    color: white;
  }
  
  .pulse-animation {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(45, 201, 138, 0.5);
    }
    70% {
      box-shadow: 0 0 0 15px rgba(45, 201, 138, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(45, 201, 138, 0);
    }
  }
  
  .carousel-inner {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .carousel-item img {
    width: 100%;
    height: 350px;
    object-fit: cover;
  }
  
  .carousel-control-prev, .carousel-control-next {
    width: 10%;
    opacity: 0.8;
  }
  
  .carousel-indicators {
    margin-bottom: 1.5rem;
  }
  
  .carousel-indicators button {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin: 0 5px;
  }
  
  .info-item {
    padding: 1.25rem;
    border-bottom: 1px solid #f1f3f5;
  }
  
  .info-item:last-child {
    border-bottom: none;
  }
  
  .info-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    display: block;
  }
  
  .info-value {
    font-weight: 500;
    color: #212529;
  }
  
  .parking-data-card {
    border-radius: 16px;
    padding: 1.5rem;
    background: white;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    margin-bottom: 24px;
  }
  
  .vacancy-badge {
    font-size: 1rem;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 30px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 992px) {
    .monitor-availability {
      margin-top: 0;
    }
    
    .monitor-hero {
      padding: 4rem 0 2rem;
    }
    
    .detail-stat {
      min-height: auto;
      padding: 1.5rem 1rem;
    }
    
    .carousel-item img {
      height: 280px;
    }
    
    .section-heading {
      margin-top: 2rem;
    }
    
    .map-container {
      height: 300px;
    }
  }
</style>
{% endblock %}

{% block main %}
<!-- Hero section -->
<div class="monitor-hero">
    <div class="container position-relative z-index-2">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'home' %}"><i class="fas fa-home me-1"></i> Home</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'parking-lot-monitors' %}">Parking Monitors</a>
                </li>
                <li class="breadcrumb-item active text-white">{{ parking_lot_monitor.name }}</li>
            </ol>
        </nav>
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold mb-3 animate__animated animate__fadeInDown">
                    {{ parking_lot_monitor.name }}
                </h1>
                <div class="d-flex flex-wrap gap-3 mb-4 animate__animated animate__fadeIn animate__delay-1s">
                    <div class="last-updated-badge">
                        <i class="fas fa-sync-alt me-2"></i>
                        Updated {{ parking_lot_monitor.dateTimeLastUpdated|timesince }} ago
                    </div>
                    {% if parking_lot_monitor.parkingLot.isPaidParking %}
                    <div class="last-updated-badge">
                        <i class="fas fa-money-bill me-2"></i>
                        PKR {{ parking_lot_monitor.parkingLot.base_price_per_hour }}/hour
                    </div>
                    {% else %}
                    <div class="last-updated-badge">
                        <i class="fas fa-hand-holding me-2"></i>
                        Free Parking
                    </div>
                    {% endif %}
                </div>
                <p class="text-white mb-4 animate__animated animate__fadeIn animate__delay-2s">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    {{ parking_lot_monitor.parkingLot.address }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Parking availability status bar -->
<div class="container">
    <div class="monitor-availability p-4 animate__animated animate__fadeInUp">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="fw-bold mb-3">Current Availability</h5>
                <div class="availability-indicator mb-2">
                    <div class="availability-bar" style="width: {{ parking_lot_monitor.get_vacancy_rate }}%; background: 
                        {% if parking_lot_monitor.get_vacancy_rate > 60 %}
                            #2dc98a
                        {% elif parking_lot_monitor.get_vacancy_rate > 30 %}
                            #ffc107
                        {% else %}
                            #dc3545
                        {% endif %}
                    "></div>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="small">
                        {{ parking_lot_monitor.free_parking_spaces }} spaces free
                    </span>
                    <span class="small">
                        {{ parking_lot_monitor.get_vacancy_rate }}% available
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a href="https://www.google.com/maps/dir/?api=1&destination={{ parking_lot_monitor.latitude }},{{ parking_lot_monitor.longitude }}" 
                   class="btn directions-btn pulse-animation" target="_blank">
                    <i class="fas fa-directions me-2"></i> Get Directions
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <!-- Key stats -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="detail-stat animate__animated animate__fadeIn" data-delay="100">
                <i class="fas fa-car-alt stat-icon"></i>
                <span class="stat-value">{{ parking_lot_monitor.free_parking_spaces }}</span>
                <span class="stat-label">Available Spaces</span>
                <div class="text-muted mt-2 small">Out of {{ parking_lot_monitor.parkingLot.parking_spaces }} total</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="detail-stat animate__animated animate__fadeIn" data-delay="300">
                <i class="fas fa-clock stat-icon"></i>
                <span class="stat-label">Operating Hours</span>
                <div class="mt-3 fw-bold fs-5">{{ parking_lot_monitor.parkingLot.hours }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="detail-stat animate__animated animate__fadeIn" data-delay="500">
                <i class="fas fa-percentage stat-icon"></i>
                <span class="stat-value">{{ parking_lot_monitor.get_vacancy_rate }}%</span>
                <span class="stat-label">Vacancy Rate</span>
                <div class="text-muted mt-2 small">
                    {% if parking_lot_monitor.get_vacancy_rate > 60 %}
                        High availability
                    {% elif parking_lot_monitor.get_vacancy_rate > 30 %}
                        Medium availability
                    {% else %}
                        Low availability
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main content - left column -->
        <div class="col-lg-6 order-2 order-lg-1">
            <h2 class="section-heading">Location</h2>
            <div class="map-container animate__animated animate__fadeIn mb-4">
                <div id="monitorMap"></div>
            </div>
            
            <h2 class="section-heading">Monitor Details</h2>
            <div class="card stat-card border-0 animate__animated animate__fadeIn">
                <div class="card-body p-0">
                    <div class="info-item">
                        <span class="info-label">Address</span>
                        <div class="info-value">{{ parking_lot_monitor.parkingLot.address }}</div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Hours of Operation</span>
                        <div class="info-value">{{ parking_lot_monitor.parkingLot.hours }}</div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <div class="info-value">{{ parking_lot_monitor.dateTimeLastUpdated|date:"F j, Y, g:i a" }}</div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Coordinates</span>
                        <div class="info-value">{{ parking_lot_monitor.latitude }}, {{ parking_lot_monitor.longitude }}</div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Parking Type</span>
                        <div class="info-value">
                            {% if parking_lot_monitor.parkingLot.isPaidParking %}
                                <span class="badge bg-warning">Paid</span> 
                                <span class="ms-2">PKR {{ parking_lot_monitor.parkingLot.base_price_per_hour }}/hour</span>
                            {% else %}
                                <span class="badge bg-success">Free</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images - right column -->
        <div class="col-lg-6 order-1 order-lg-2">
            <h2 class="section-heading">Live Camera Feed</h2>
            {% if parking_lot_monitor.images.all %}
            <div id="parkingImagesCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    {% for image in parking_lot_monitor.images.all %}
                    <button type="button" data-bs-target="#parkingImagesCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                            class="{% if forloop.first %}active{% endif %}"
                            aria-current="{% if forloop.first %}true{% endif %}" 
                            aria-label="Slide {{ forloop.counter }}"></button>
                    {% endfor %}
                </div>
                <div class="carousel-inner">
                    {% for image in parking_lot_monitor.images.all %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ image.url }}" class="d-block w-100" alt="Parking Image {{ forloop.counter }}">
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#parkingImagesCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#parkingImagesCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            {% else %}
            <div class="mb-4">
                <img src="{{ parking_lot_monitor.image.url }}" class="img-fluid rounded" 
                     style="width:100%; height:350px; object-fit:cover; border-radius:16px; box-shadow:0 5px 15px rgba(0,0,0,0.1);"
                     alt="Parking Image"/>
            </div>
            {% endif %}
            
            <!-- Additional parking data -->
            <div class="parking-data-card animate__animated animate__fadeIn animate__delay-1s">
                <h4 class="mb-4">Current Parking Data</h4>
                <div class="row g-4">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-car-alt" style="font-size:2.5rem; color:#44b8f3;"></i>
                            </div>
                            <h5 class="fw-bold text-center mb-0">{{ parking_lot_monitor.free_parking_spaces }}</h5>
                            <p class="text-muted small">Available Spaces</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-ban" style="font-size:2.5rem; color:#dc3545;"></i>
                            </div>
                            <h5 class="fw-bold text-center mb-0">
                                {{ parking_lot_monitor.parkingLot.parking_spaces|add:"-"|add:parking_lot_monitor.free_parking_spaces }}
                            </h5>
                            <p class="text-muted small">Occupied Spaces</p>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <div class="text-center">
                    <span class="vacancy-badge" 
                          style="background-color: 
                            {% if parking_lot_monitor.get_vacancy_rate > 60 %}
                                #e3fcef; color: #2dc98a;
                            {% elif parking_lot_monitor.get_vacancy_rate > 30 %}
                                #fff3cd; color: #ffc107;
                            {% else %}
                                #f8d7da; color: #dc3545;
                            {% endif %}
                          "
                    >
                        <i class="fas fa-parking me-2"></i>
                        {{ parking_lot_monitor.get_vacancy_rate }}% Vacancy Rate
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map
        const map = L.map('monitorMap').setView([{{ parking_lot_monitor.latitude }}, {{ parking_lot_monitor.longitude }}], 16);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Custom marker icon
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div style="background: linear-gradient(135deg, #2dc98a 0%, #44b8f3 100%); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                    <i class="fas fa-parking"></i>
                </div>
            `,
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });
        
        // Add marker for parking lot
        const marker = L.marker([{{ parking_lot_monitor.latitude }}, {{ parking_lot_monitor.longitude }}], {
            icon: customIcon
        }).addTo(map);
        
        // Add popup with info
        marker.bindPopup(`
            <div style="width: 200px;">
                <h5 style="font-weight: bold; margin-bottom: 8px;">{{ parking_lot_monitor.name }}</h5>
                <p style="margin-bottom: 8px; font-size: 14px;">{{ parking_lot_monitor.parkingLot.address }}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; color: 
                        {% if parking_lot_monitor.get_vacancy_rate > 60 %}
                            #2dc98a
                        {% elif parking_lot_monitor.get_vacancy_rate > 30 %}
                            #ffc107
                        {% else %}
                            #dc3545
                        {% endif %}
                    ">
                        {{ parking_lot_monitor.free_parking_spaces }}/{{ parking_lot_monitor.parkingLot.parking_spaces }} spaces
                    </span>
                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ parking_lot_monitor.latitude }},{{ parking_lot_monitor.longitude }}" 
                       style="background: #2dc98a; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;"
                       target="_blank">
                       <i class="fas fa-directions"></i> Directions
                    </a>
                </div>
            </div>
        `).openPopup();
        
        // Add intersection observers for scroll animations
        const elements = document.querySelectorAll('.animate__animated');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const delay = entry.target.getAttribute('data-delay') || 0;
                    setTimeout(() => {
                        entry.target.classList.add('animate__fadeIn');
                        entry.target.style.opacity = 1;
                    }, delay);
                }
            });
        }, { threshold: 0.1 });
        
        elements.forEach(element => {
            if (!element.classList.contains('animate__fadeInDown') && 
                !element.classList.contains('animate__fadeInUp') &&
                !element.classList.contains('animate__fadeInLeft') &&
                !element.classList.contains('animate__fadeInRight')) {
                element.style.opacity = 0;
                element.classList.remove('animate__fadeIn');
                observer.observe(element);
            }
        });
        
        // Initialize availability bar width animation
        setTimeout(() => {
            document.querySelector('.availability-bar').style.width = '{{ parking_lot_monitor.get_vacancy_rate }}%';
        }, 500);
    });
</script>
{% endblock %}
